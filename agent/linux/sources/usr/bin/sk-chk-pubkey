#!/bin/bash


# TODO
# - Retrieve the pubkey from some Revolve controled website
# - Add retry mechanic when querying the API

# Load commons constants and functions
. /usr/lib/sovereign-keys/commons.sh

usage () {
    echo "Usage: $0 [<OPTIONS>]"
    echo ""
    echo "Sovereign Keys signing public key verification"
    echo "Compares the local version of the signing public key with the version served by the API"
    echo "OPTIONS:"
    echo -e "-h|--help\t\tShow this help"
}

POSITIONAL=()
while [[ $# -gt 0 ]]
do
    key="$1"
    case $key in
        -h|--help)
            usage
            exit 0
        ;;
        *)    # unknown option
            POSITIONAL+=("$1") # save it in an array for later
            shift # past argument
        ;;
    esac
done

# Retrieve the local version of the public key
echo "Retrieve local version of the Revolve public signing key"
LOCAL_KEY=$(get_local_pubkey)

# Retrieve the remote version of the public key
echo "Retrieve remote version of the Revolve public signing key"
REMOTE_KEY=$(curl -sf -H "Authorization: Custom" -X GET $BASE_URL/public-signing-key | jq -r .public_key)

# Control they are identical
if [ "$LOCAL_KEY" != "$REMOTE_KEY" ] ; then
    echo "CRITICAL: The local and remote version of the Revolve Sovereign Keys public signing key differs"
    exit 1
fi

echo "Keys are identical"
exit 0
